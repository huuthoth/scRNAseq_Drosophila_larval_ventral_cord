---
title: "Figure 5-glia subclustering analysis"
output: html_document
date: "04-22-21"
note: The code used in this analysis is associated with the following publications: PMID: 33600085 and PMID: 38569548.
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## List of the software and algorithms utilized in this protocol
#R version 3.6.2
#RStudio version 1.1.463
#BiocManager version 3.11
#Nebulosa version 0.99.02	
#scran version 1.16.0
#Seurat version 3.1
#SingleCellExperiment version 1.10.1
## Install and Load Packages
library(Seurat)
library(ggplot2)
library(Nebulosa)


```{r cars}
```

##Load Seurat_VNCs
setwd("~.../Seurat_VNCs")
Seurat_VNCs <- readRDS("Seurat_VNCs.rds")

##Subset glia clusters
glia <- SubsetData(Seurat_VNCs, ident.use = c(10, 27, 14, 20, 22, 23, 26, 24), assay="RNA") #3817 cells

DefaultAssay(glia) <- "RNA"

##remove neuronal cells
glia<-subset(glia, subset = `elav` > 0, slot = 'counts',  invert = TRUE) #3351  cells
glia<-subset(glia, subset = `Gad1` > 0, slot = 'counts',  invert = TRUE) #3300  cells
glia<-subset(glia, subset = `VGAT` > 0, slot = 'counts',  invert = TRUE) #3297  cells
glia<-subset(glia, subset = `VGlut` > 0, slot = 'counts',  invert = TRUE) #3177  cells
glia<-subset(glia, subset = `ChAT` > 0, slot = 'counts',  invert = TRUE) #3169  cells
glia<-subset(glia, subset = `VAChT` > 0, slot = 'counts',  invert = TRUE) #3157  cells
glia<-subset(glia, subset = `DAT` > 0, slot = 'counts',  invert = TRUE) #3148   cells

##split glia object by sample
split_glia <- SplitObject(glia, split.by = "sample")
split_glia <- split_glia[c("VNC1", "VNC2", "VNC3", "VNC4", "VNC5")]

## find variable features
for (sample_name in names(split_glia)) {
  message("Processing: ", sample_name)
  split_glia[[sample_name]] <- FindVariableFeatures(
    split_glia[[sample_name]], 
    selection.method = "vst", 
    nfeatures = 1000, 
    verbose = FALSE
  )
}

## select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = split_glia)

## Perform integration
glia.anchors <- FindIntegrationAnchors(object.list = split_glia, dims = 1:30)

## create list of common genes to keep
to_integrate <- Reduce(intersect, lapply(glia.anchors@object.list, rownames))

## integrate data and keep full geneset
glia.integrated <- IntegrateData(anchorset = glia.anchors)

DefaultAssay(glia) <- "integrated"

##Scale, dimensionality reduction, and clustering analysis
glia.integrated <- ScaleData(glia, features = rownames(glia))

glia.integrated <- RunPCA(glia.integrated, 
                                 ndims.print = 1:30, nfeatures.print = 30, npcs = 50)

DimHeatmap(glia.integrated, dims = 1:12, cells = 100, balanced = TRUE)
DimHeatmap(glia.integrated, dims = 13:25, cells = 100, balanced = TRUE)
DimHeatmap(glia.integrated, dims = 40:55, cells = 100, balanced = TRUE)

glia.integrated <- JackStraw(glia1, num.replicate = 100)
glia.integrated <- ScoreJackStraw(glia1, dims = 1:20)
JackStrawPlot(glia.integrated, dims = 1:20)

ElbowPlot(glia.integrated, ndims = 50)

glia.integrated <- FindNeighbors(glia.integrated, reduction = "pca", dims = 1:20)
glia.integrated <- RunUMAP(glia.integrated, reduction = "pca", dims = 1:20)
glia.integrated <- RunTSNE(glia.integrated, reduction = "pca", dims = 1:20)

##Investigating Cluster Separation at Different Resolutions using clustree Package and silhouette metric
glia.integrated <- FindClusters(glia.integrated, resolution = c(0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9 1.0 ))

##clustree
library(clustree)
clustree(glia.integrated)

## silhouette metric
library(cluster, quietly = TRUE)
a<-Embeddings(object = glia.integrated, reduction = "tsne")
dist.matrix <- dist(x = a)
clusters <- glia.integrated$seurat_clusters
sil <- silhouette(x = as.numeric(x = as.factor(x = clusters)), dist = dist.matrix)
plot(sil)
plot(sil, col = heat.colors(46))
##average_sil=0.33

## We decided to use resolution 0.3 for our data
glia.integrated <- FindClusters(glia.integrated, resolution = 0.3)

DimPlot(glia.integrated, reduction = "tsne", pt.size = 0.9, label = TRUE, label.size = 7)


##find marker
glia.markers <- FindAllMarkers(object = glia, 
                                      only.pos = TRUE, 
                                      logfc.threshold = 0.05, assay = 'RNA', slot = c('data'))
library(readxl)
library(openxlsx)

top10 <- glia.markers %>% group_by(cluster) %>% top_n(n = 15, wt = avg_logFC)

DoHeatmap(subset(glia.integrated, downsample = 100), features = top10$gene, disp.min = -1.0, disp.max = 1.0) 

ggsave(paste0("~/Desktop/ScRNA seq paper", "in-heat-res1.5.0.png"), height = 116, width = 46, unit = "cm",
       device = "png", dpi = 600)

##saveRDS
setwd(".../VNC_atlas")

saveRDS(glia.integrated, file = "glia_VNC.rds")

##Fig.5_A
#
glia <- RenameIdents(object = glia, 
                     "0"= "CG1",
                     "8"= "CG2",
                     "3"= "EG",
                     
                     "2" = "PG",
                     "7" = "SPG",
                     
                     "5" = "MG",
                     "1" = "AG",
                     "9" = "GP",
                     "6"="twi+",
                     "4" = "Unanotated")

DimPlot(object = glia, reduction = 'tsne', label = T,
        cols = c("CG1"="darkgoldenrod1",
                 "AG"="magenta4",
                 "PG"="forestgreen",
                 
                 "EG"="brown",
                 "UA"="lightsteelblue3",
                 
                 "MG"="lightseagreen",
                 "twi+"="tomato",
                 "SPG"="slateblue1",
                 "CG2"="deeppink",
                 "GP"="blue2"),  pt.size = 1,  label.size = 7)
                 
ggsave(paste0("~/glia/", "Glia-tsne.png"), height = 6, width = 8, unit = "cm",device = "png", dpi = 300) 


##Fig.5_B
glia@active.ident <- factor(glia@active.ident,levels=c("Unanotated","twi+","CG2","CG1","EG","AG","SPG","PG","MG","GP"))

features =c("elav","repo",
            "gcm","gcm2", 
            "N", "E(spl)m4-BFM", "stg", #Precursor -cl9
            
            "comm", "wrapper", 
            "NetA", "sli", "Egfr", "aos", "Smox", "dally",
            "Epac", "tsl",  #MG-cl5
            
            "Tret1-1", "MFS3", "CG4797", 
            
            "CG5080", "NKCC","nrv3", "kar","GLS", "daw","ImpL2",#PG-cl2.
        
           
            "moody", "Mdr65",#SG-cl7
            "ltl", "Swim", "Sdr", "rost",
            
            "alrm", #AG- cl1
            "Gat","e", "scf", "Swip-1","wun2",
            
            "Adgf-D","Adk1",
            
            "Eaat2", #Ensheathing glia like
            "CG9657", 
            "axo","CG30197","Argk", "Pcp", "Sox14", 
            
            
            "zyd",#CG -cl0 and cl8
            "apolpp","Jabba", "Idgf6", "Picot", "mnd", "Ama","Obp99a",
            
            "twi", "Him", 
            "Idgf2", "CG9338")  #no repo, wrapper in 40%- cl6
DotPlot(glia, features = features, cols = c("white","green4"), col.min = -0.3, col.max = 1.0, assay = "RNA")

ggsave(paste0("~../glia", "Glia-markers.png"), height = 7, width = 35.5, unit = "cm",
       device = "png", dpi = 300) 
       
       

